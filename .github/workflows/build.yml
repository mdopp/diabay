###############################################################################
# DiaBay - GitHub Actions CI/CD Pipeline
#
# Builds frontend and creates deployment artifacts
# Pre-built artifacts can be used for installations without Node.js
###############################################################################

name: Build and Package

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # FRONTEND TESTS
  # ============================================================================
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --silent

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run type-check

  # ============================================================================
  # BACKEND TESTS
  # ============================================================================
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-test.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install -r requirements.txt -r requirements-test.txt

      - name: Run tests
        run: pytest tests/ --verbose

  # ============================================================================
  # FRONTEND BUILD
  # ============================================================================
  frontend-build:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [ frontend-test ]
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --silent

      - name: Build production bundle
        run: npm run build

      - name: Show build info
        run: |
          echo "Build completed at $(date)"
          du -sh dist/
          ls -la dist/

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 30

  # ============================================================================
  # PACKAGE WINDOWS
  # ============================================================================
  package-windows:
    name: Package Windows
    runs-on: ubuntu-latest
    needs: [ frontend-build, backend-test ]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Create Windows package
        run: |
          mkdir -p package/diabay

          # Copy application files
          cp -r frontend/dist package/diabay/frontend/
          cp -r backend package/diabay/

          # Copy documentation
          cp README.md WINDOWS_SETUP.md DEPLOYMENT.md INSTALLATION.md package/diabay/

          # Copy installers
          cp install.ps1 install.bat package/diabay/

          # Create zip
          cd package
          zip -r ../diabay-windows-${{ github.sha }}.zip diabay/
          cd ..
          ls -lh diabay-windows-*.zip

      - name: Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: diabay-windows
          path: diabay-windows-*.zip
          retention-days: 90

  # ============================================================================
  # PACKAGE LINUX
  # ============================================================================
  package-linux:
    name: Package Linux
    runs-on: ubuntu-latest
    needs: [ frontend-build, backend-test ]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Create Linux package
        run: |
          mkdir -p package/diabay

          # Copy application files
          cp -r frontend/dist package/diabay/frontend/
          cp -r backend package/diabay/

          # Copy documentation
          cp README.md DEPLOYMENT.md INSTALLATION.md package/diabay/

          # Copy installers
          cp install.sh package/diabay/
          chmod +x package/diabay/install.sh

          # Create tarball
          cd package
          tar czf ../diabay-linux-${{ github.sha }}.tar.gz diabay/
          cd ..
          ls -lh diabay-linux-*.tar.gz

      - name: Upload Linux package
        uses: actions/upload-artifact@v4
        with:
          name: diabay-linux
          path: diabay-linux-*.tar.gz
          retention-days: 90

  # ============================================================================
  # CREATE RELEASE (Tags only)
  # ============================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [ package-windows, package-linux ]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release assets
        run: |
          mkdir -p release
          mv artifacts/diabay-windows/*.zip release/
          mv artifacts/diabay-linux/*.tar.gz release/

          # Rename with version tag
          cd release
          for file in *; do
            newname=$(echo "$file" | sed "s/${{ github.sha }}/${{ github.ref_name }}/g")
            mv "$file" "$newname"
          done
          ls -lh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
          body: |
            ## DiaBay ${{ github.ref_name }}

            Professional Slide & Film Digitization System

            ### Installation

            **Windows:**
            ```powershell
            # Download diabay-windows-${{ github.ref_name }}.zip
            # Extract and run install.bat
            ```

            **Linux:**
            ```bash
            # Download diabay-linux-${{ github.ref_name }}.tar.gz
            tar xzf diabay-linux-${{ github.ref_name }}.tar.gz
            cd diabay
            ./install.sh
            ```

            ### What's Included
            - ✅ Pre-built frontend (Node.js not required)
            - ✅ Complete backend code
            - ✅ Interactive installers
            - ✅ Full documentation

            See [INSTALLATION.md](https://github.com/mdopp/diabay/blob/main/INSTALLATION.md) for detailed instructions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
